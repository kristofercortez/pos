{% extends "GistTemplateBundle::base.html.twig" %}
{% import "GistTemplateBundle::form.html.twig" as form_tools %}
{% block content %}
<div class="page-content">

        <br>
    <div class="row" style="margin-right: 0px !important;">
        <div class="col-md-2" style="padding-right: 1px !important; border: 0px !important;">
        	<div class="portlet box blue-hoki" style="background-color: #2D2D2D;border: 0px !important;">
                <div class="portlet-title">
                    <div class="caption">Product Categories</div>
                </div>
                <div class="portlet-body form" id="prod_cats" style="height: 440px; overflow:scroll;overflow-x: hidden;">
                	
                </div>
            </div>
        </div>
        <div class="col-md-4" style="padding-right: 1px !important; padding-left: 5px !important;">
        	<div class="portlet box blue-hoki" style="background-color: #2D2D2D;border: 0px !important;">
                <div class="portlet-title">
                    <div class="caption">Products <span id="selected_pcat"></span></div>
                </div>
                <div class="portlet-body form">
                	<br>
                    <div  style="height: 440px;overflow:scroll; overflow-x: hidden;">
                	<div class="row" id="prods">
                		
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6" style="padding-left: 1px !important; padding-right: 0px !important;">
        	<div class="portlet box blue-hoki" style="background-color: #ffffff;border: 0px !important;">
                <div class="portlet-title">
                    <div class="caption">Cart</div>
                </div>
                <div class="portlet-body form">
                <div style="overflow:scroll; overflow-x: hidden; height: 330px;">
                <table class="table table-striped table-bordered table-hover" style="margin-top: 20px;" id="cart_table">
                    <thead>
                        <tr>
                            <th width="60%">Item</th>
                            <th width="30%">Price</th>
                            <th width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="cart_items">

                    </tbody>
                </table>
                </div>
                <div class="row">
                {{ form.group_text('Approval Code', 'app_code', '', 4, 6, false) }}
                </div>
                <br>
                <a href="javascript:void(0)" class="btn next_step_btn" style="background-color: #556E93; color: #ffffff;">Next Step</a>
                <a href="javascript:void(0)" class="btn bulk_adj" style="background-color: #556E93; color: #ffffff;">Bulk Discount</a>
                <a href="javascript:void(0)" class="btn checkout_btn" style="background-color: green; color: #ffffff;">Checkout</a>
                <a href="" class="btn" style="background-color: red; color: #ffffff;">Clear Cart</a>

                <input type="hidden" id="cart_min_price" name="cart_min_price" value="0">
                <input type="hidden" id="cart_int_price" name="cart_int_price" value="0">
                <input type="hidden" id="cart_int_orig_price" name="cart_int_price" value="0">
                <h3 class="orig_price_h3">Original Total: <b>Php <span id="cart_orig_price" value="0">0</span></b></h3>
                <h4 class="bulk_discount_h4">Bulk Discount: <b><span id="applied_bulk_discount" value=""></span></b></h4>
                <h3>Total: <b>Php <span id="cart_price" value="0">0</span></b></h3>
                    
                </div>
            </div>
        </div>
    </div>

    <div id="item_adjustment" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="">
                    <div class="modal-header">
                        <input type="hidden" id="item_adjustment_prod_id" value="0">
                        <a type="button" class="close" data-dismiss="modal" aria-hidden="true"></a>
                        <h4 id="form_title" class="modal-title">Item Price Adjustment Form</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row form-horizontal form">
                            {{ form.group_select('Option', 'indiv_adj', indiv_options, '', 3, 4, false) }}
                            {{ form.group_text('New Price', 'new_price', '', 3, 4, false) }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a class="btn default green apply_indiv" data-dismiss="modal" style="margin=0" href="javascript:void(0)">Apply</a>
                        <button type="button" data-dismiss="modal" class="btn default" data-toggle="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="bulk_adjustment" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="">
                    <div class="modal-header">
                        <a type="button" class="close" data-dismiss="modal" aria-hidden="true"></a>
                        <h4 id="form_title" class="modal-title">Bulk Adjustment Form</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row form-horizontal form">
                            {{ form.group_select('Option', 'bulk_adj', bulk_options, '', 3, 4, false) }}
                            {{ form.group_text('New Price', 'new_total', '', 3, 4, false) }}
                            {{ form.group_text('Discount Amount', 'discount_amount', '', 3, 4, false) }}
                            {{ form.group_text('Discount %', 'discount_pct', '', 3, 4, false) }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a class="btn default green apply_bulk" data-dismiss="modal" style="margin=0" href="javascript:void(0)">Apply</a>
                        <button type="button" data-dismiss="modal" class="btn default" data-toggle="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="transaction_type_modal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="">
                    <div class="modal-header">
                        <a type="button" class="close" data-dismiss="modal" aria-hidden="true"></a>
                        <h4 id="form_title" class="modal-title">Select Transaction Type</h4>
                    </div>
                    <div class="modal-body">
                        <div class="row form-horizontal form">
                            {{ form.group_select('Type', 'trans_opts', trans_options, '', 3, 4, false) }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a class="btn default green proceed_btn" data-dismiss="modal" style="margin=0" href="javascript:void(0)">Proceed</a>
                        <button type="button" data-dismiss="modal" class="btn default" data-toggle="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block js %}
<script>
function hideItemAdjustment()
{
    $('.indiv_adj').each(function() {
        $(this).hide();
    });
}
function showItemAdjustment()
{
    $('.indiv_adj').each(function() {
        $(this).show();
    });
}
function addToCart(product_name, srp, min_price, id)
{
    //id = erp product id
    var row_id = Math.round(new Date().getTime() + (Math.random() * 100));
    var field = '<tr class=\"row_prod_'+row_id+'\">';     
        field += '<input type=\"hidden\" name=\"product_id[]\" class=\"product_id\" value=\"'+row_id+'\" >';
        field += '<input type=\"hidden\" name=\"min_price[]\" class=\"min_price\" value=\"'+min_price+'\" >';
        field += '<input type=\"hidden\" name=\"srp[]\" class=\"srp\" value=\"'+srp+'\" >';
        field += '<input type=\"hidden\" name=\"product_amt[]\" class=\"product_amt\" value=\"'+srp+'\" >';
        field += '<td><input type="text" style=\"font-size: 10px !important;\" value="'+product_name+'" readonly="true" class="form-control item_name"></td>';
        field += '<td><input type="text" style=\"font-size: 10px !important;\" name="display_price[]" class="form-control display_price" readonly="true" value="'+srp+'"></td>';  
        field += '<td ><a href="javascript:void(0)" class="btn btn-xs default red remove_row"><i class="fa fa-times" aria-hidden="true"></i></a><a href="javascript:void(0)" class="btn btn-xs default green indiv_adj"><i class="fa fa-pencil" aria-hidden="true"></i></a></td>'; 
        field += '</tr>';

        $('#cart_items').prepend(field);
        hideItemAdjustment();
        computeCart();
        computeCartMinimum();
}
function computeCart()
{
    var total = 0;
    $('.display_price').each(function(){
        total = total + parseInt($(this).val());
    });

    $('#cart_int_price').val(total);
    $('#cart_int_orig_price').val(total);
    $("#cart_price").text(addCommas(total.toString()));
    $("#cart_orig_price").text(addCommas(total.toString()));
    console.log('Sell Price:'+total);
}
function computeCartMinimum()
{
    var total = 0;
    $('.min_price').each(function(){
        total = total + parseInt($(this).val());
    });

    $("#cart_min_price").val(addCommas(total.toString()));
    console.log('Min Price:'+total);

    if (total > $('#cart_int_price').val()) {
        $('#cgroup-app_code').show();
    } else {
        $('#cgroup-app_code').hide();
    }
}
function ajaxGetProductCategories()
{
    $( "#prod_cats" ).empty();
    $( "#prods" ).empty();
    $("#prod_cats").append("<div style=\"height: 10px;\">");
    // var url = "http://dev.gisterp2/inventory/pos/get/product_categories";
    var url = "http://erp.cilanthropist.co/inventory/pos/get/product_categories";
    $.getJSON(url, function(json){  
       $.each(json, function(i, item) {
            var img = "http://nahmdong.com/vitalhill/img/default.png";
            if (item.image_url != null) {
                img = item.image_url;
            }
            // alert(item.name);
            $("#prod_cats").append("<button class=\"btn btn-md btn-block category_btn\" id=\"cat_btn_"+item.id+"\" onclick=\"ajaxGetProducts("+item.id+")\" style=\"background-color: #556E93; color: #ffffff; border-radius: 5px !important;\">"+item.name+"</button>");

            $("#prods").append("<div class=\"col-md-6\" style=\"margin: 0px !important; padding: 1px !important\" >\
                    <a href=\"#\" class=\"category_btn2\" style=\"text-decoration: none;\" onclick=\"ajaxGetProducts("+item.id+")\">\
                    <div class=\"thumbnail\" style=\"margin: 0px !important;border-width: 1px !important; border-color: #7e88ff !important; border-radius: 5px !important;\">\
                        <img src="+img+" style=\"height: 150px; width: 80%; display: block;\">\
                        <div class=\"caption\" style=\"font-size: 12px !important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">\
                            <h3 style=\"font-size: 12px !important; margin: 0!important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">"+item.name+"</h3>\
                        </div>\
                    </div>\
                    </a>\
                </div>");
        });
    });
}
function ajaxGetProducts(cid)
{

    $( "#prods" ).empty();
    $("#prods").append("<div class=\"col-md-12\"><h2>&nbsp;&nbsp;&nbsp;Loading products...</h2></div>");
    $("#cat_btn_"+cid).css({'background-color': '#484c50'});
    $( "#prods" ).empty();
    // $("#prods").append("<div class=\"col-md-4\" style=\"margin: 0px !important; padding: 2px !important\" >\
    //                 <a href=\"#\" class=\"category_btn2\" style=\"text-decoration: none;\" onclick=\"ajaxGetProductCategories()\">\
    //                 <div class=\"thumbnail\" style=\"margin: 0px !important\">\
    //                     <img src=\"\" style=\"height: 150px; width: 80%; display: block;\">\
    //                     <div class=\"caption\" style=\"font-size: 12px !important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">\
    //                         <h3 style=\"font-size: 12px !important; margin: 0!important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">Go Back</h3>\
    //                     </div>\
    //                 </div>\
    //                 </a>\
    //             </div>");
    
    // var url = "http://dev.gisterp2/inventory/pos/get/products/"+cid;
    var url = "http://erp.cilanthropist.co/inventory/pos/get/products/"+cid;
    $.getJSON(url, function(json){  
        var count = 0;
       $.each(json, function(i, item) {
        count++;
        var price = 0;
        if (item.srp != null) {
            price = item.srp;
        } 

        var img = "http://nahmdong.com/vitalhill/img/default.png";
        if (item.image_url != null) {
            img = item.image_url;
        }

            $("#prods").append("<div class=\"col-md-6\" style=\"margin: 0px !important; padding: 2px !important\" >\
                    <a href=\"#\" style=\"text-decoration: none;\" onclick=\"addToCart('"+item.name+"',"+price+","+item.min_price+","+item.id+")\">\
                    <div class=\"thumbnail\" style=\"margin: 0px !important; border-width: 1px !important; border-color: #7e88ff !important; border-radius: 5px !important;\">\
                        <img src="+img+" style=\"height: 150px; width: 80%; display: block;\">\
                        <div class=\"caption\" style=\"font-size: 12px !important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">\
                            <h3 style=\"font-size: 12px !important; margin: 0!important; text-overflow: ellipsis !important; white-space: nowrap; overflow: hidden;\">"+item.name+"</h3>\
                            <h3 style=\"font-size: 12px !important; margin: 0!important;\"><b>PHP "+price+"</b></h3>\
                        </div>\
                    </div>\
                    </a>\
                </div>");

        });

       if (count == 0) {
            $( "#prods" ).empty();
            $("#prods").append("<div class=\"col-md-12\"><h2>&nbsp;&nbsp;No products in selected category</h2></div>");
       }
    });
}
function addCommas(nStr)
{
    nStr += '';
    x = nStr.split('.');
    x1 = x[0];
    x2 = x.length > 1 ? '.' + x[1] : '';
    var rgx = /(\d+)(\d{3})/;
    while (rgx.test(x1)) {
        x1 = x1.replace(rgx, '$1' + ',' + '$2');
    }
    return x1 + x2;
}

function applyIndividualAdjustment()
{   
    var indiv_adj_opt = $('#cform-indiv_adj').val();
    if (indiv_adj_opt != '') {
        var selected_prod_id = $('#item_adjustment_prod_id').val();
        var row = $("#cart_table > tbody > tr.row_prod_"+selected_prod_id);
        var srp = row.find('.srp').val();

        if (indiv_adj_opt == 'gift') {
            row.find('.display_price').val('0.00');
        } else if (indiv_adj_opt == '40p') {
            var discounted_srp = srp * .4;
            row.find('.display_price').val(discounted_srp);
        } else if (indiv_adj_opt == 'chg') {
            row.find('.display_price').val($('#cform-new_price').val());
        } else {
            row.find('.display_price').val(srp);
        }
    } else {

    }
}

function hideCartLastColumn()
{
    $('td:last-child').each(function(){
        $(this).css("display", "none");
    });

    $('th:last-child').each(function(){
        $(this).css("display", "none");
    });
}

function showCartLastColumn()
{
    $('td:last-child').each(function(){
        $(this).css("display", "");
    });

    $('th:last-child').each(function(){
        $(this).css("display", "");
    });
}

function proceedToTransaction()
{
    var select_trans = $('#cform-trans_opts').val();
    if (select_trans != '') {
        $("#prods").addClass("disabledbutton");

        $("#prod_cats").addClass("disabledbutton");
        if (select_trans == 'reg') {
            $('.next_step_btn').hide();
            $('.checkout_btn').show();
            $('.remove_row').hide();
            hideCartLastColumn();
        } else if (select_trans == 'per') {
            hideCartLastColumn();
            $('#cart_table').find('tr').each(function(){
                $(this).find('th').eq(2).after('<th>Type</th>');
                $(this).find('td').eq(2).after("<td style=\"font-size: 10px !important;\">\
                    {{ form.group_select_only('Type', 'trans_opts', indiv_options, '', 12, 12, false)|e('js') }}</td>");
            });

            $('#cart_table').find('tr').each(function(){
                $(this).find('th').eq(3).after('<th>Adjusted</th>');
                $(this).find('td').eq(3).after('<td><input type="text" style=\"font-size: 10px !important;\" class="form-control item_name" readonly="true" value="0.00"></td>');
            });

            var ths = $('th');
            var element = ths.eq(0);
            element.width(200);
            var element2 = ths.eq(1);
            element2.width(100);
        } else if (select_trans == 'bulk') {
            $('.next_step_btn').hide();
            $('.remove_row').hide();
            $('.bulk_adj').show();
            $('.bulk_discount_h4').show();
            $('.checkout_btn').show();
            $('.orig_price_h3').show();
        } else {

        }
    } else {

    }
}

function applyBulkAdjustment()
{   
    var bulk_adj_opt = $('#cform-bulk_adj').val();
    if (bulk_adj_opt != '') {
        if (bulk_adj_opt == 'bgift') {
            // $('.display_price').each(function() {
            //     $(this).val('0.00');
            //     computeCart();
            //     computeCartMinimum();
            // });
            $('#cart_price').text(0);
            $('#cart_int_price').val(0);
            $('#applied_bulk_discount').text('Gift');
        } else if (bulk_adj_opt == 'bdiscamt') {
            computeCart();
            computeCartMinimum();
            var new_cart_total = $('#cart_int_price').val() - $('#cform-discount_amount').val();
            if (new_cart_total >= 0) {
                $('#cart_price').text(addCommas(new_cart_total));
                $('#cart_int_price').val(new_cart_total);
                $('#applied_bulk_discount').text('Less Php '+$('#cform-discount_amount').val()+'');
            }
        } else if (bulk_adj_opt == 'bdisc') {
            computeCart();
            computeCartMinimum();
            var new_cart_total = $('#cart_int_price').val() - ($('#cart_int_price').val() * ($('#cform-discount_pct').val()/100));
            if (new_cart_total >= 0) {
                $('#cart_price').text(addCommas(new_cart_total));
                $('#cart_int_price').val(new_cart_total);
                $('#applied_bulk_discount').text('Less '+$('#cform-discount_pct').val()+'% off');
            }
        } else if (bulk_adj_opt == 'bamt') {
            computeCart();
            computeCartMinimum();
            $('#cart_int_price').val($('#cform-new_total').val());
            $('#cart_price').text(addCommas($('#cform-new_total').val()));
            $('#applied_bulk_discount').text('Change Amount');
        } else {
            $('.display_price').each(function() {
                if ($(this).val() == "0" || $(this).val() == "0.00") {
                    //revert prices only if bulk discount came from gift
                    var row = $(this).closest('tr');
                    var srp = row.find('.srp').val();
                    $(this).val(srp);
                }
                
            });
            $('#applied_bulk_discount').text('');
            computeCart();
            computeCartMinimum();
        }
    } else {

    }
}

function revertOriginalPrices()
{
    $('.display_price').each(function() {
        if ($(this).val() == "0" || $(this).val() == 0.00) {
            //revert prices only if bulk discount came from gift
            var row = $(this).closest('tr');
            var srp = row.find('.srp').val();
            $(this).val(srp);
        }
        
    });
    computeCart();
    computeCartMinimum();
}

function hideBulkAmounts()
{
    $('#cform-discount_amount').val('');
    $('#cgroup-discount_amount').hide();
    $('#cform-discount_pct').val('');
    $('#cgroup-discount_pct').hide();
    $('#cform-new_total').val('');
    $('#cgroup-new_total').hide();
}

function cancelBulkAdjustment()
{
    revertOriginalPrices();
    $('#cgroup-new_total').hide();
    $('#cform-new_total').val('');
    $('#cform-discount_amount').val('');
    $('#cgroup-discount_amount').hide();
    $('#cform-discount_pct').val('');
    $('#cgroup-discount_pct').hide();
    $('.display_price').each(function() {
        if ($(this).val() == "0" || $(this).val() == 0.00) {
            //revert prices only if bulk discount came from gift
            var row = $(this).closest('tr');
            var srp = row.find('.srp').val();
            $(this).val(srp);
        }
        
    });

    

}

$(document).ready(function(){
    $('#cgroup-app_code').hide();
    $('.bulk_adj').hide();
    $('.checkout_btn').hide();
    $('.orig_price_h3').hide();
    $('.bulk_discount_h4').hide();
    ajaxGetProductCategories();

    $('#cform-new_price').val('');
    $('#cgroup-new_price').hide();
    hideBulkAmounts();

    //Select Trans Type
    $(document).on("click",".next_step_btn", function(e){
        $('#transaction_type_modal').modal('show');
    });

    //Proceed
    $(document).on("click",".proceed_btn", function(e){
        proceedToTransaction();
    });

    $(document).on("click",".apply_indiv", function(e){
        applyIndividualAdjustment();
    });

    $(document).on("click",".apply_bulk", function(e){
        applyBulkAdjustment();
    });

    $(window).keydown(function(event){
        if(event.keyCode == 13) {
          event.preventDefault();
          return false;
        }
    });

    

    
    $(document).on("click",".category_btn", function(e){

        $('.category_btn').each(function() {
            $(this).css({'background-color': '#556E93'});
        });
        $('#selected_pcat').text(' - '+$(this).html());
        $(this).css({'background-color': '#484c50'});
    });

    $('#cform-indiv_adj').on("change", function()
    {
        var indiv_adj_opt = $('#cform-indiv_adj').val();
        if (indiv_adj_opt == 'chg') {
            $('#cform-new_price').val('');
            $('#cgroup-new_price').show();
        } else {
            $('#cgroup-new_price').hide();
            $('#cform-new_price').val('');
        }
    });

    $('#cform-bulk_adj').on("change", function()
    {
        var bulk_adj_opt = $('#cform-bulk_adj').val();
        $('.indiv_adj').each(function() {
            $(this).hide();
        });

        $('.remove_row').each(function() {
            $(this).hide();
        });

        $("#prods").addClass("disabledbutton");
        $("#prod_cats").addClass("disabledbutton");

        if (bulk_adj_opt == 'bgift') {

        } else if (bulk_adj_opt == 'bamt') {
            hideBulkAmounts();
            $('#cform-new_total').val('');
            $('#cgroup-new_total').show();
            // revertOriginalPrices();
        } else if (bulk_adj_opt == 'bdiscamt') {
            hideBulkAmounts();
            $('#cform-discount_amount').val('');
            $('#cgroup-discount_amount').show();
            // revertOriginalPrices();
        } else if (bulk_adj_opt == 'bdisc') {
            hideBulkAmounts();
            $('#cform-discount_pct').val('');
            $('#cgroup-discount_pct').show();
            
        } else {
            cancelBulkAdjustment();
        }
    });


    $('#item_adjustment').on('hidden.bs.modal', function () {
      //recompute cart total after update
      $('#item_adjustment_prod_id').val(0.00);
      $("#cform-indiv_adj").val('').trigger('change');
      computeCart();
      computeCartMinimum();
    });

    $('#bulk_adjustment').on('shown.bs.modal', function () {

    });

    $('#bulk_adjustment').on('hidden.bs.modal', function () {
      //recompute cart total after update
      // $("#cform-bulk_adj").val('').trigger('change');
        $('#cgroup-new_total').hide();
        $('#cform-new_total').val('');
        $('#cform-discount_amount').val('');
        $('#cgroup-discount_amount').hide();
        $('#cform-discount_pct').val('');
        $('#cgroup-discount_pct').hide();
        computeCartMinimum();

    });

    $(document).on("click",".remove_row", function(e){
            e.preventDefault();            
            var tr = $(this).closest('tr');
            tr.remove();
            computeCart();
            computeCartMinimum();
            return false;
        });


    //$("#prods").append("<div class=\"col-md-12\"><h2>Select a product category</h2></div>");

    $(document).on("click",".indiv_adj", function(e){
        $('#item_adjustment').modal('show');
        var selected_prod_id = $(this).closest('tr').find('.product_id').val();
        // alert(selected_prod_id);
        $('#item_adjustment_prod_id').val(selected_prod_id);
    });

    $(document).on("click",".bulk_adj", function(e){
        $('#bulk_adjustment').modal('show');
    });


    $("#cform-discount_pct").keyup(function() {
        $("#cform-discount_pct").val(this.value.match(/[0-9]*/));
    });

    $("#cform-discount_amount").keyup(function() {
        $("#cform-discount_amount").val(this.value.match(/[0-9]*/));
    });

    $("#cform-new_price").keyup(function() {
        $("#cform-new_price").val(this.value.match(/[0-9]*/));
    });




});
</script>
{% endblock %}